<div class="attendance-container">
  <div class="page-header">
    <div class="title">
      <h1>Attendance Deductions</h1>
      <p class="muted">
        Import sheet → compute grace/penalties → review per employee.
      </p>
    </div>

    <div class="actions">
      <button class="btn btn-primary" type="button" (click)="goToImport()">
        Import sheet
      </button>
      <button class="btn" type="button" (click)="goToMapping()">
        Mapping
      </button>
      <button class="btn" type="button" (click)="goToExcuses()">
        Excuses
      </button>
    </div>
  </div>

  <div class="filters-bar" [formGroup]="form">
    <div class="field">
      <label>Month</label>
      <input type="month" formControlName="month" />
    </div>

    <div class="field">
      <label>Search</label>
      <input type="text" formControlName="q" placeholder="Employee name / National ID" />
    </div>

    <div class="field checkbox">
      <label class="check">
        <input type="checkbox" formControlName="includeSalary" />
        <span>Include salary (Finance/Admin)</span>
      </label>
    </div>

    <button class="btn btn-ghost" type="button" (click)="load()">Refresh</button>
  </div>

  <div *ngIf="state() === 'error' && errorMsg()" class="alert alert-error">
    {{ errorMsg() }}
  </div>

  <div *ngIf="state() === 'loading'" class="loading">
    Loading...
  </div>

  <ng-container *ngIf="state() === 'success' && summary() as s">
    <div class="kpis">
      <div class="kpi">
        <div class="kpi-title">Working days (from sheet)</div>
        <div class="kpi-value">{{ s.workingDaysCount }}</div>
      </div>

      <div class="kpi">
        <div class="kpi-title">Employees</div>
        <div class="kpi-value">{{ kpiEmployeesCount() }}</div>
      </div>

      <div class="kpi">
        <div class="kpi-title">Total penalty days</div>
        <div class="kpi-value">{{ kpiTotalPenaltyDays() | number: '1.0-2' }}</div>
      </div>

      <div class="kpi" *ngIf="form.controls.includeSalary.value">
        <div class="kpi-title">Total deduction amount</div>
        <div class="kpi-value">{{ formatMoney(kpiTotalDeductionAmount()) }}</div>
      </div>
    </div>

    <div class="table-wrap">
      <table class="data-table">
        <thead>
          <tr>
            <th>Employee</th>
            <th class="num">Penalty days</th>
            <th class="num">Absent days</th>
            <th class="num">Grace used</th>
            <th class="num">Excuse minutes</th>

            <th class="num" *ngIf="form.controls.includeSalary.value">Day rate</th>
            <th class="num" *ngIf="form.controls.includeSalary.value">Deduction</th>

            <th class="actions-col">Action</th>
          </tr>
        </thead>

        <tbody>
          <tr *ngFor="let r of filteredRows()">
            <td>
              <div class="emp">
                <div class="name">{{ r.employee?.fullName || ('Employee #' + r.employeeId) }}</div>
                <div class="meta" *ngIf="r.employee?.nationalId">NID: {{ r.employee?.nationalId }}</div>
              </div>
            </td>

            <td class="num">{{ r.totalPenaltyDays | number: '1.0-2' }}</td>
            <td class="num">{{ r.absentDays }}</td>
            <td class="num">{{ r.graceUsedCount }}</td>
            <td class="num">{{ r.totalExcuseMinutes }}</td>

            <td class="num" *ngIf="form.controls.includeSalary.value">
              {{ formatMoney(r.dayRate) }}
            </td>
            <td class="num" *ngIf="form.controls.includeSalary.value">
              {{ formatMoney(r.deductionAmount) }}
            </td>

            <td class="actions-col">
              <button class="btn btn-small" type="button" (click)="openEmployee(r)">
                View
              </button>
            </td>
          </tr>

          <tr *ngIf="filteredRows().length === 0">
            <td [attr.colspan]="form.controls.includeSalary.value ? 8 : 6" class="empty">
              No data for selected month.
            </td>
          </tr>
        </tbody>
      </table>
    </div>
  </ng-container>
</div>
