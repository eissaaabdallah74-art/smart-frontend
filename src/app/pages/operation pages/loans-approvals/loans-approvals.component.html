<section class="page">
  <header class="page-head">
    <div>
      <div class="title">Loans approvals</div>
      <div class="subtitle">
        Filter by month and employee to see totals, then approve/reject
      </div>
    </div>

    <div class="head-actions">
      <button class="btn btn--ghost" (click)="refresh()" [disabled]="loading">
        Refresh
      </button>
    </div>
  </header>

  <div *ngIf="infoMsg" class="alert alert--info">{{ infoMsg }}</div>
  <div *ngIf="errorMsg" class="alert alert--danger">{{ errorMsg }}</div>

  <ng-container *ngIf="!infoMsg">
    <!-- KPIs (month + requester filter) -->
    <div class="stats">
      <div class="stat-card">
        <div class="stat-label">Total requested (month)</div>
        <div class="stat-value">{{ money(kpi().sumAll) }}</div>
        <div class="stat-sub">Requests: {{ kpi().countAll }}</div>
      </div>

      <div class="stat-card stat-card--pending">
        <div class="stat-label">Pending (month)</div>
        <div class="stat-value">{{ money(kpi().sumPending) }}</div>
        <div class="stat-sub">Pending: {{ kpi().countPending }}</div>
      </div>

      <div class="stat-card stat-card--approved">
        <div class="stat-label">Approved (month)</div>
        <div class="stat-value">{{ money(kpi().sumApproved) }}</div>
        <div class="stat-sub">Approval rate: {{ kpi().approvalRate }}%</div>
      </div>

      <div class="stat-card stat-card--rejected">
        <div class="stat-label">Rejected (month)</div>
        <div class="stat-value">{{ money(kpi().sumRejected) }}</div>
        <div class="stat-sub">Rejected: {{ kpi().countRejected }}</div>
      </div>
    </div>

    <div class="card">
      <div class="card-title">Filters</div>

      <div class="filters">
        <label class="field">
          <span class="label">Month</span>
          <input class="input" type="month" [(ngModel)]="month" name="month" />
        </label>

        <label class="field">
          <span class="label">Employee</span>
          <select class="input" [(ngModel)]="requesterId" name="requesterId">
            <option [ngValue]="'all'">All</option>
            <option *ngFor="let u of requesters()" [ngValue]="u.id">
              {{ u.name }} ({{ u.id }})
            </option>
          </select>
        </label>

        <label class="field">
          <span class="label">Status</span>
          <select class="input" [(ngModel)]="status" name="status" (ngModelChange)="refresh()">
            <option value="pending">Pending</option>
            <option value="approved">Approved</option>
            <option value="rejected">Rejected</option>
            <option value="all">All</option>
          </select>
        </label>

        <label class="field field--wide">
          <span class="label">Search</span>
          <input class="input" [(ngModel)]="q" name="q" placeholder="Name / ID / Amount" />
        </label>

        <div class="filter-actions">
          <button class="btn btn--primary" (click)="refresh()" [disabled]="loading">
            Apply   
          </button>
        </div>
      </div>

      <div class="hint">
        Tip: choose an employee + month to get their totals immediately from the KPI cards above.
      </div>
    </div>

    <div class="card">
      <div class="card-title">Results</div>

      <div class="table-wrap" *ngIf="!loading; else loadingTpl">
        <table class="table">
          <thead>
            <tr>
              <th>ID</th>
              <th>Requester</th>
              <th>Amount</th>
              <th>Status</th>
              <th>Created</th>
              <th>Decision note</th>
              <th class="col-actions">Actions</th>
            </tr>
          </thead>

          <tbody>
            <ng-container *ngFor="let r of filteredRows()">
              <tr>
                <td class="mono">#{{ r.id }}</td>
                <td>{{ r.requesterName }}</td>
                <td class="mono">{{ money(r.amount) }}</td>
                <td>
                  <span [class]="statusClass(r.status)">{{ statusLabel(r.status) }}</span>
                </td>
                <td>{{ fmtDate(r.createdAt) }}</td>

                <td>
                  <input
                    class="input input--small"
                    [(ngModel)]="decisionNote[r.id]"
                    placeholder="Optional"
                    [disabled]="r.status !== 'pending'"
                  />
                </td>

                <td class="actions">
                  <button
                    class="btn btn--ghost btn--sm"
                    type="button"
                    (click)="toggleDetails(r.id)"
                  >
                    {{ expandedId === r.id ? 'Hide' : 'Details' }}
                  </button>

                  <button
                    class="btn btn--success btn--sm"
                    (click)="approve(r.id)"
                    [disabled]="r.status !== 'pending'"
                  >
                    Approve
                  </button>

                  <button
                    class="btn btn--danger btn--sm"
                    (click)="reject(r.id)"
                    [disabled]="r.status !== 'pending'"
                  >
                    Reject
                  </button>
                </td>
              </tr>

              <tr *ngIf="expandedId === r.id" class="details-row">
                <td colspan="7">
                  <div class="details">
                    <div class="details-item">
                      <div class="details-label">Staff note</div>
                      <div class="details-value">{{ r.note || '—' }}</div>
                    </div>

                    <div class="details-item">
                      <div class="details-label">Manager note (current)</div>
                      <div class="details-value">{{ r.managerNote || '—' }}</div>
                    </div>
                  </div>
                </td>
              </tr>
            </ng-container>

            <tr *ngIf="filteredRows().length === 0">
              <td colspan="7" class="empty">No results</td>
            </tr>
          </tbody>
        </table>
      </div>

      <ng-template #loadingTpl>
        <div class="loading">Loading...</div>
      </ng-template>
    </div>
  </ng-container>
</section>
