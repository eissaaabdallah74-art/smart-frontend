<div class="modal-backdrop" (click)="requestClose()"></div>

<div
  class="modal"
  role="dialog"
  aria-modal="true"
  aria-label="User form"
  (click)="$event.stopPropagation()"
>
  <header class="modal-head">
    <h3 class="modal-title">
      {{ isEditMode ? 'Edit User' : 'Add New User' }}
    </h3>

    <button
      class="icon-btn"
      type="button"
      (click)="requestClose()"
      aria-label="Close"
      [disabled]="saving"
      [style.opacity]="saving ? 0.6 : 1"
      [style.cursor]="saving ? 'not-allowed' : 'pointer'"
    >
      ×
    </button>
  </header>

  <!-- ✅ NEW: API error banner inside modal -->
  <div class="modal-error" *ngIf="apiError">
    <div class="modal-error__title">Something went wrong</div>
    <div class="modal-error__msg">{{ apiError }}</div>
  </div>

  <form #f="ngForm" (ngSubmit)="onSubmit(f)" class="modal-body" novalidate>
    <div class="form-grid">
      <!-- ================= Employee Dropdown ================= -->
      <div class="form-group form-group--full">
        <label class="form-label">Employee (optional)</label>

        <div class="employee-select">
          <button
            type="button"
            class="employee-trigger"
            (click)="toggleEmployeeDropdown()"
            [class.is-open]="employeeDropdownOpen"
            [disabled]="saving"
          >
            <span class="employee-trigger__text">
              <span class="employee-name">
                {{ selectedEmployee?.fullName || 'Select employee...' }}
              </span>

              <span class="employee-email" *ngIf="selectedEmployee?.corporateEmail">
                {{ selectedEmployee?.corporateEmail }}
              </span>

              <span class="employee-email" *ngIf="selectedEmployee && !selectedEmployee.corporateEmail">
                —
              </span>

              <span class="employee-email employee-email--hint" *ngIf="!selectedEmployee">
                Name will appear here, email under it
              </span>
            </span>

            <span class="employee-caret">▾</span>
          </button>

          <div class="employee-panel" *ngIf="employeeDropdownOpen">
            <div class="employee-panel__top">
              <input
                class="employee-search"
                name="employeeQuery"
                [(ngModel)]="employeeQuery"
                placeholder="Search by name or email..."
                [disabled]="saving"
              />

              <button
                type="button"
                class="employee-clear"
                (click)="clearEmployeeSelection()"
                [disabled]="saving"
              >
                Clear
              </button>
            </div>

            <div class="employee-loading" *ngIf="employeesLoading">
              Loading employees...
            </div>

            <div class="employee-error" *ngIf="employeesError">
              {{ employeesError }}
            </div>

            <div class="employee-options" *ngIf="!employeesLoading && !employeesError">
              <button
                type="button"
                class="employee-option employee-option--none"
                (click)="clearEmployeeSelection()"
                [disabled]="saving"
              >
                <div class="employee-option__name">No employee (manual)</div>
                <div class="employee-option__email">Create user without linking</div>
              </button>

              <button
                type="button"
                class="employee-option"
                *ngFor="let e of filteredEmployees()"
                (click)="selectEmployee(e)"
                [disabled]="saving || isEmployeeDisabled(e)"
                [class.is-disabled]="isEmployeeDisabled(e) || saving"
              >
                <div class="employee-option__name">
                  {{ e.fullName }}
                  <span class="employee-badge" *ngIf="e.authUserId">
                    Linked
                  </span>
                </div>
                <div class="employee-option__email">
                  {{ e.corporateEmail || '—' }}
                </div>
              </button>
            </div>
          </div>
        </div>

        <div class="help-text" style="margin-top: 6px;">
          Select employee to link this user account (name + corporate email).
        </div>
      </div>

      <!-- ================= Existing Fields ================= -->

      <div class="form-group">
        <label class="form-label" for="fullName">Full Name *</label>
        <input
          id="fullName"
          name="fullName"
          class="form-input"
          [(ngModel)]="model.fullName"
          required
          [disabled]="saving"
          #fullNameInput="ngModel"
        />
        <div class="error-message" *ngIf="fullNameInput.invalid && fullNameInput.touched">
          Full name is required
        </div>
      </div>

      <div class="form-group">
        <label class="form-label" for="email">Email *</label>
        <input
          id="email"
          name="email"
          type="email"
          class="form-input"
          [(ngModel)]="model.email"
          required
          [disabled]="saving"
          #emailInput="ngModel"
        />
        <div class="error-message" *ngIf="emailInput.invalid && emailInput.touched">
          Valid email is required
        </div>
      </div>

      <div class="form-group">
        <label class="form-label" for="role">Department *</label>
        <select
          id="role"
          name="role"
          class="form-input"
          [(ngModel)]="model.role"
          required
          [disabled]="saving"
          #roleInput="ngModel"
        >
          <option value="" disabled>Select department...</option>
          <option *ngFor="let r of roles" [value]="r">
            {{ formatRole(r) }}
          </option>
        </select>
        <div class="error-message" *ngIf="roleInput.invalid && roleInput.touched">
          Department is required
        </div>
      </div>

      <div class="form-group">
        <label class="form-label" for="position">Position</label>
        <select
          id="position"
          name="position"
          class="form-input"
          [(ngModel)]="model.position"
          [disabled]="saving || !availablePositions.length"
        >
          <option value="">
            {{ !availablePositions.length ? 'Not applicable' : 'Select position...' }}
          </option>
          <option *ngFor="let p of availablePositions" [ngValue]="p.value">
            {{ p.label }}
          </option>
        </select>
        <div class="help-text" *ngIf="!availablePositions.length && model.role">
          No positions available for {{ formatRole(model.role) }}
        </div>
      </div>

      <div class="form-group">
        <label class="form-label" for="hireDate">Hire Date</label>
        <input
          id="hireDate"
          name="hireDate"
          type="date"
          class="form-input"
          [(ngModel)]="model.hireDate"
          [disabled]="saving"
        />
      </div>

      <div class="form-group" *ngIf="!model.isActive">
        <label class="form-label" for="terminationDate">Termination Date</label>
        <input
          id="terminationDate"
          name="terminationDate"
          type="date"
          class="form-input"
          [(ngModel)]="model.terminationDate"
          [disabled]="saving || model.isActive"
        />
      </div>

      <div class="form-group form-group--checkbox">
        <label class="checkbox-label">
          <input
            type="checkbox"
            name="isActive"
            [(ngModel)]="model.isActive"
            (change)="onStatusChange()"
            [disabled]="saving"
          />
          <span>Active User</span>
        </label>
        <div class="help-text">
          {{ model.isActive ? 'User can login to the system' : 'User account is disabled' }}
        </div>
      </div>

      <div class="form-group form-group--full">
        <label class="form-label" for="password">
          Password {{ !isEditMode ? '*' : '' }}
        </label>
        <input
          id="password"
          name="password"
          type="password"
          class="form-input"
          [(ngModel)]="model.password"
          [required]="!isEditMode"
          [disabled]="saving"
          [placeholder]="
            isEditMode
              ? 'Leave blank to keep current password'
              : 'Enter a secure password'
          "
          #passwordInput="ngModel"
        />
        <div class="error-message" *ngIf="passwordInput.invalid && passwordInput.touched && !isEditMode">
          Password is required for new users
        </div>
        <div class="help-text" *ngIf="isEditMode">
          Leave blank to keep the current password unchanged
        </div>
      </div>
    </div>

    <footer class="modal-foot">
      <button type="button" class="btn btn--secondary" (click)="requestClose()" [disabled]="saving">
        Cancel
      </button>

      <button type="submit" class="btn btn--primary" [disabled]="saving">
        {{ saving ? 'Saving...' : (isEditMode ? 'Save Changes' : 'Add User') }}
      </button>
    </footer>
  </form>
</div>