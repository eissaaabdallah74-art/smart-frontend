<!-- src/app/pages/.../drivers/components/driver-details/driver-details.component.html -->

<div class="backdrop" *ngIf="!isStandaloneRoute" (click)="onCloseClick()"></div>

<div class="profile-container" [class.is-page]="isStandaloneRoute">
  <header class="top-nav">
    <button class="nav-back-btn" (click)="onCloseClick()">
      <i class="ri-arrow-left-s-line"></i>
      <span>Back</span>
    </button>

    <div class="nav-actions">
      <span class="ticket-badge" *ngIf="vm?.courierCode">
        <i class="ri-hashtag"></i> Code: {{ vm?.courierCode }}
      </span>

      <span class="ticket-badge" *ngIf="!vm?.courierCode && vm?.courierId">
        <i class="ri-fingerprint-line"></i> ID: {{ vm?.courierId }}
      </span>

      <button
        class="close-icon-btn"
        *ngIf="!isStandaloneRoute"
        (click)="onCloseClick()"
      >
        <i class="ri-close-line"></i>
      </button>
    </div>
  </header>

  <!-- Drawer Error State (لو Drawer فقط) -->
  <ng-container *ngIf="!loading && loadError && !isStandaloneRoute">
    <div class="layout-grid">
      <section class="content-card">
        <h3 class="card-title">
          <i class="ri-error-warning-line"></i> Failed to load
        </h3>
        <div class="empty-state">{{ loadError }}</div>
        <div style="margin-top: 0.75rem; display: flex; gap: 0.5rem">
          <button class="action-btn primary" (click)="onCloseClick()">
            <i class="ri-arrow-go-back-line"></i> Close
          </button>
        </div>
      </section>
    </div>
  </ng-container>

  <ng-container *ngIf="!loading && !loadError && vm as row; else loadingSkeleton">
    <div class="layout-grid">
      <!-- LEFT -->
      <aside class="col-identity">
        <div class="profile-card">
          <div class="profile-status" [ngClass]="statusClass">
            {{ statusText }}
          </div>

          <div class="profile-header">
            <div class="avatar-circle">{{ initials }}</div>
            <h1 class="profile-name">{{ row.name || 'Unnamed driver' }}</h1>
            <p class="profile-role">
              {{ row.clientName || 'Driver' }}
            </p>
          </div>

          <div class="highlights-row">
            <div class="highlight-badge" *ngIf="row.vehicleType">
              <i
                class="ri-motorbike-line"
                *ngIf="row.vehicleType.toLowerCase().includes('motor')"
              ></i>
              <i
                class="ri-car-line"
                *ngIf="!row.vehicleType.toLowerCase().includes('motor')"
              ></i>
              {{ row.vehicleType }}
            </div>

            <div class="highlight-badge secondary" *ngIf="row.residence">
              <i class="ri-home-4-line"></i> {{ row.residence }}
            </div>

            <div class="highlight-badge secondary" *ngIf="row.area">
              <i class="ri-map-pin-2-line"></i> {{ row.area }}
            </div>
          </div>

          <div class="divider"></div>

          <div class="contact-section">
            <div class="contact-row">
              <i class="ri-phone-line"></i>
              <span>{{ row.courierPhone || 'No phone' }}</span>
              <button
                class="copy-btn"
                title="Copy"
                (click)="copyText('Phone', row.courierPhone)"
                [disabled]="!row.courierPhone"
              >
                <i class="ri-file-copy-line"></i>
              </button>
            </div>

            <div class="contact-row">
              <i class="ri-mail-line"></i>
              <span>{{ row.email || 'No email' }}</span>
              <button
                class="copy-btn"
                title="Copy"
                (click)="copyText('Email', row.email)"
                [disabled]="!row.email"
              >
                <i class="ri-file-copy-line"></i>
              </button>
            </div>

            <div class="contact-row" *ngIf="row.courierId">
              <i class="ri-fingerprint-line"></i>
              <span>{{ row.courierId }}</span>
              <button
                class="copy-btn"
                title="Copy"
                (click)="copyText('Courier ID', row.courierId)"
              >
                <i class="ri-file-copy-line"></i>
              </button>
            </div>
          </div>

          <div class="profile-actions">
            <button class="action-btn primary" (click)="callDriver()" [disabled]="!row.courierPhone">
              <i class="ri-phone-fill"></i> Call Driver
            </button>
          </div>
        </div>

        <div class="toast" *ngIf="copiedToast">{{ copiedToast }}</div>
      </aside>

      <!-- RIGHT -->
      <main class="col-details">
        <!-- Top highlights -->
        <section class="highlights-grid">
          <div class="highlight-box brand-theme">
            <div class="hb-icon"><i class="ri-building-4-line"></i></div>
            <div class="hb-content">
              <label>Client Account</label>
              <div class="hb-value">{{ row.clientName || 'Not Assigned' }}</div>
              <div class="hb-sub">
                <i class="ri-user-star-line"></i>
                Manager:
                <strong>{{ row.accountManager || '—' }}</strong>
              </div>
            </div>
          </div>

          <div class="highlight-box blue-theme">
            <div class="hb-icon"><i class="ri-route-line"></i></div>
            <div class="hb-content">
              <label>Assignment</label>
              <div class="hb-value">{{ row.hub || 'No Hub' }}</div>
              <div class="hb-sub">
                <i class="ri-map-pin-2-line"></i>
                {{ row.area || 'No Area' }} · {{ row.module || 'No Module' }}
              </div>
            </div>
          </div>

          <div
            class="highlight-box status-theme"
            [class.is-signed]="row.signed"
            [class.not-signed]="!row.signed"
          >
            <div class="hb-icon">
              <i class="ri-file-paper-2-line" *ngIf="!row.signed"></i>
              <i class="ri-checkbox-circle-fill" *ngIf="row.signed"></i>
            </div>
            <div class="hb-content">
              <label>Contract Status</label>
              <div class="hb-value">
                {{ row.signed ? 'Signed' : 'Not signed' }}
              </div>
              <div class="hb-sub">
                <i class="ri-shield-check-line"></i>
                {{ row.contractStatus || 'N/A' }} · {{ row.hiringStatus || 'N/A' }}
              </div>
            </div>
          </div>
        </section>

        <!-- Profile / Identity -->
        <section class="content-card">
          <h3 class="card-title">
            <i class="ri-user-3-line"></i> Profile & Identity
          </h3>

          <div class="info-grid">
            <div class="info-box">
              <label>Name (EN)</label>
              <div class="val">{{ row.name || '—' }}</div>
            </div>

            <div class="info-box">
              <label>Name (AR)</label>
              <div class="val">{{ row.fullNameArabic || '—' }}</div>
            </div>

            <div class="info-box">
              <label>Contractor</label>
              <div class="val">{{ row.contractor || '—' }}</div>
            </div>

            <div class="info-box">
              <label>Point of contact</label>
              <div class="val">{{ row.pointOfContact || '—' }}</div>
            </div>

            <div class="info-box">
              <label>Interviewer</label>
              <div class="val">{{ row.interviewer || '—' }}</div>
            </div>

            <div class="info-box">
              <label>HR representative</label>
              <div class="val">{{ row.hrRepresentative || '—' }}</div>
            </div>
          </div>
        </section>

        <!-- Dates & Documents -->
        <section class="content-card">
          <h3 class="card-title">
            <i class="ri-calendar-event-line"></i> Dates & Documents
          </h3>

          <div class="info-grid">
            <div class="info-box">
              <label>Hiring date</label>
              <div class="val">{{ row.hiringDate || '—' }}</div>
            </div>

            <div class="info-box">
              <label>Day 1 date</label>
              <div class="val">{{ row.day1Date || '—' }}</div>
            </div>

            <div class="info-box">
              <label>V-license expiry</label>
              <div class="val">{{ row.vLicenseExpiryDate || '—' }}</div>
            </div>

            <div class="info-box">
              <label>D-license expiry</label>
              <div class="val">{{ row.dLicenseExpiryDate || '—' }}</div>
            </div>

            <div class="info-box">
              <label>ID expiry</label>
              <div class="val">{{ row.idExpiryDate || '—' }}</div>
            </div>

            <div class="info-box">
              <label>Liability amount</label>
              <div class="val">
                {{
                  row.liabilityAmount !== null && row.liabilityAmount !== undefined
                    ? row.liabilityAmount
                    : '—'
                }}
              </div>
            </div>

            <div class="info-box">
              <label>Security status</label>
              <div class="val">{{ row.securityQueryStatus || '—' }}</div>
            </div>

            <div class="info-box">
              <label>Exception by</label>
              <div class="val">{{ row.exceptionBy || '—' }}</div>
            </div>
          </div>
        </section>

        <!-- Notes (Chat style like interview feedback) -->
        <section class="content-card" *ngIf="hasAnyNotes">
          <h3 class="card-title">
            <i class="ri-chat-quote-line"></i> Notes & Remarks
          </h3>

          <div class="feedback-list">
            <div class="feedback-item" *ngIf="row.securityQueryComment">
              <div class="feedback-avatar is-interviewer">
                <i class="ri-shield-check-line"></i>
              </div>
              <div class="feedback-content">
                <div class="feedback-author">Security comment</div>
                <div class="feedback-text">{{ row.securityQueryComment }}</div>
              </div>
            </div>

            <div class="feedback-item" *ngIf="row.notes">
              <div class="feedback-avatar is-crm">
                <i class="ri-sticky-note-line"></i>
              </div>
              <div class="feedback-content">
                <div class="feedback-author">General notes</div>
                <div class="feedback-text">{{ row.notes }}</div>
              </div>
            </div>

            <div class="empty-state" *ngIf="!row.securityQueryComment && !row.notes">
              No notes recorded yet.
            </div>
          </div>
        </section>
      </main>
    </div>
  </ng-container>

  <ng-template #loadingSkeleton>
    <div class="skeleton-loader">
      <div class="sk-side"></div>
      <div class="sk-main">
        <div class="sk-grid-3"></div>
        <div class="sk-card"></div>
        <div class="sk-card"></div>
      </div>
    </div>
  </ng-template>
</div>
