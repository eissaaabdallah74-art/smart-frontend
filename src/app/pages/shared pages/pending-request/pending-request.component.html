<section class="pending-requests-shell">
  <div class="pending-requests-container">
    <!-- Header -->
    <app-pr-header
      [loading]="loading"
      [activeTab]="activeTab"
      [totalRows]="totalRows"
      [summaryLastUpdatedAt]="summaryLastUpdatedAt"
      [lastUpdateLabel]="summaryLastUpdateLabel"
      [clientTabs]="clientTabs"
      [selectedClientId]="selectedClientId"
      (downloadTemplate)="downloadImportTemplate()"
      (exportExcel)="exportFilteredAsExcel()"
      (importExcel)="onImportExcelFile($event)"
      (createNew)="openCreate()"
      (tabChange)="setTab($event)"
      (clientTabChange)="setClientTab($event)"
    ></app-pr-header>

    <!-- Alerts -->
    <div *ngIf="errorMsg" class="alert error">
      {{ errorMsg }}
    </div>

    <div *ngIf="toastMsg" class="alert success">
      {{ toastMsg }}
    </div>

    <!-- Excel pre-validation errors -->
    <div *ngIf="importValidationErrors.length" class="alert error">
      <div class="muted small">
        Excel validation errors (showing first
        {{ importValidationErrors.length }}):
      </div>

      <ul class="errors-list">
        <li *ngFor="let e of importValidationErrors">
          Row {{ e.row }} — {{ e.message }}
        </li>
      </ul>
    </div>

    <!-- Backend import result -->
    <div *ngIf="importResult" class="alert info">
      Import result: created {{ importCreatedCount }} / updated
      {{ importUpdatedCount }} / skipped {{ importSkippedCount }} / failed
      {{ importFailedCount }} (total {{ importResult.total }}).

      <div class="muted small" *ngIf="firstImportErrors.length">
        First backend errors:
        <ul class="errors-list">
          <li *ngFor="let e of firstImportErrors">
            #{{ e.index }} — {{ e.message }}
          </li>
        </ul>
      </div>
    </div>

    <!-- ===================== -->
    <!-- Summary Tab -->
    <!-- ===================== -->
    <ng-container *ngIf="activeTab === 'summary'">
      <app-pr-summary
        *ngIf="activeTab === 'summary'"
        [rows]="filteredRequests"
        [clients]="clients"
        [vehicleTypes]="vehicleTypes"
        [vehicleTypeColumns]="vehicleTypeColumns"
      ></app-pr-summary>
    </ng-container>

    <!-- ===================== -->
    <!-- List Tab -->
    <!-- ===================== -->
    <ng-container *ngIf="activeTab === 'list'">
      <!-- Filters bar -->
      <div class="filters-bar">
        <div class="filters-left">
          <div class="search-box">
            <span class="search-icon">⌕</span>
            <input
              class="search-input"
              type="text"
              [(ngModel)]="search"
              (ngModelChange)="onSearchChanged()"
              placeholder="Search client / hub / zone / notes / billing..."
            />
          </div>

          <div class="filters-inline">
            <select
              class="select compact"
              [(ngModel)]="selectedVehicleType"
              (ngModelChange)="onVehicleTypeChanged()"
            >
              <option [ngValue]="''">All vehicle types</option>
              <option *ngFor="let v of vehicleTypes" [ngValue]="v.value">
                {{ v.label }}
              </option>
            </select>

            <select
              class="select compact"
              [(ngModel)]="selectedPriority"
              (ngModelChange)="onServerFiltersChanged()"
            >
              <option *ngFor="let p of priorities" [ngValue]="p.value">
                {{ p.label }}
              </option>
            </select>
          </div>

          <button
            type="button"
            class="btn ghost small"
            (click)="clearFilters()"
          >
            Clear
          </button>
        </div>

        <div class="filters-right">
          <div class="page-size">
            <span class="muted small">Rows:</span>
            <select
              class="select compact"
              [(ngModel)]="pageSize"
              (ngModelChange)="onPageSizeChange()"
            >
              <option *ngFor="let s of pageSizeOptions" [ngValue]="s">
                {{ s }}
              </option>
            </select>
          </div>

          <div class="view-toggle">
            <button
              type="button"
              class="btn ghost small"
              [class.active]="viewMode === 'cards'"
              (click)="setViewMode('cards')"
            >
              Cards
            </button>
            <button
              type="button"
              class="btn ghost small"
              [class.active]="viewMode === 'table'"
              (click)="setViewMode('table')"
            >
              Table
            </button>
          </div>
        </div>
      </div>

      <!-- content box -->
      <div
        class="table-wrap"
        [class.loading]="loading"
        [class.is-table]="viewMode === 'table'"
        [class.is-cards]="viewMode === 'cards'"
      >
        <ng-container *ngIf="pagedRequests?.length; else emptyStateTpl">
          <!-- Cards view -->
          <app-pr-cards
            *ngIf="viewMode === 'cards'"
            [rows]="pagedRequests"
            [loading]="loading"
            [priorityLabel]="priorityLabel.bind(this)"
            [priorityClass]="priorityClass.bind(this)"
            (edit)="openEdit($event)"
            (remove)="confirmDelete($event)"
            (details)="openDetails($event)"
            (quickDecrement)="
              quickDecrementItem($event.row, $event.index, $event.ev)
            "
          ></app-pr-cards>

          <!-- Table view -->
          <app-pr-table
            *ngIf="viewMode === 'table'"
            [rows]="pagedRequests"
            [loading]="loading"
            [isRowExpanded]="isRowExpanded.bind(this)"
            [toggleRowExpanded]="toggleRowExpanded.bind(this)"
            [priorityLabel]="priorityLabel.bind(this)"
            [priorityClass]="priorityClass.bind(this)"
            [getRowTotal]="getRowTotal.bind(this)"
            [getVehicleChips]="getVehicleChips.bind(this)"
            [getVehicleGroups]="getVehicleGroups.bind(this)"
            [getVehicleLabel]="getVehicleLabel.bind(this)"
            [getPricingColLabel]="getPricingColLabel.bind(this)"
            (details)="openDetails($event)"
            (edit)="openEdit($event)"
            (remove)="confirmDelete($event)"
            (quickDecrement)="
              quickDecrementItem($event.row, $event.index, $event.ev)
            "
          ></app-pr-table>
        </ng-container>

        <div class="loading-overlay" *ngIf="loading">
          <div class="spinner"></div>
        </div>
      </div>

      <!-- Pagination -->
      <div class="pagination-bar" *ngIf="totalRows > 0">
        <div class="pagination-meta muted small">
          Showing {{ pageStartIndex + 1 }}–{{ pageEndIndex }} of {{ totalRows }}
        </div>

        <div class="pagination-actions">
          <button
            type="button"
            class="btn ghost small"
            (click)="firstPage()"
            [disabled]="page <= 1"
          >
            First
          </button>
          <button
            type="button"
            class="btn ghost small"
            (click)="prevPage()"
            [disabled]="page <= 1"
          >
            Prev
          </button>

          <div class="page-indicator">
            <span class="muted small">Page</span>
            <input
              class="page-input"
              type="number"
              [ngModel]="page"
              (ngModelChange)="goToPage($event)"
              min="1"
              [max]="totalPages"
            />
            <span class="muted small">/ {{ totalPages }}</span>
          </div>

          <button
            type="button"
            class="btn ghost small"
            (click)="nextPage()"
            [disabled]="page >= totalPages"
          >
            Next
          </button>
          <button
            type="button"
            class="btn ghost small"
            (click)="lastPage()"
            [disabled]="page >= totalPages"
          >
            Last
          </button>
        </div>
      </div>

      <ng-template #emptyStateTpl>
        <div class="empty-state">
          <h3>No requests found</h3>
          <p>
            Try changing filters/search, or add a new request from the button
            above.
          </p>
        </div>
      </ng-template>

      <!-- ✅ Editor Modal Component -->
      <app-pr-editor-modal
        [open]="showEditor"
        [loading]="loading"
        [isEditMode]="isEditMode"
        [form]="form"
        [clients]="clients"
        [hubs]="hubs"
        [zones]="zones"
        [priorities]="priorities"
        [vehicleTypes]="vehicleTypes"
        (close)="closeEditor()"
        (submit)="submit()"
        (addItem)="addItem()"
        (removeItem)="removeItem($event)"
        (increment)="incrementCount($event)"
        (decrement)="decrementCount($event)"
      ></app-pr-editor-modal>

      <!-- ✅ Details Modal Component -->
      <app-pr-details-modal
        [open]="!!detailsRow"
        [row]="detailsRow"
        [priorityLabel]="priorityLabel.bind(this)"
        [priorityClass]="priorityClass.bind(this)"
        [getVehicleLabel]="getVehicleLabel.bind(this)"
        (close)="closeDetails()"
      ></app-pr-details-modal>
    </ng-container>
  </div>
</section>
